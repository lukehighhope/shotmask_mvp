# 为什么当前枪声检测成功率低（约 17% F1）

## 一、数据上的表现

- **真值**：5 段视频共 136 枪（1.txt～5.txt）
- **检出**：约 222 个检测，其中 **31 个命中（TP）**，**191 个误报（FP）**，**105 枪漏检（FN）**
- **结论**：约 **77% 的真枪没被检出**，且误报很多

---

## 二、主要原因

### 1. 漏检多（FN 高）：候选阶段就丢了，或分数被压掉

- **Stage1**：用谱通量/onset 找“疑似枪声”的峰，数量不少（例如 1.mp4 有 155 个候选）。
- **Stage2**：按时间聚类，每簇只留 1 个（`cluster_loser` 很大），再用手工特征 + LogReg + CNN 打置信度，最后用 **min_confidence_threshold=0.32** 过滤。
- 若**真枪时刻**要么没被 Stage1 当成峰、要么在聚类时被当成“同簇里较弱的”被丢掉，就会直接 FN。
- 若真枪时刻有候选，但 LogReg/CNN 给的 **confidence 经常 < 0.32**，也会被当前阈值滤掉 → FN。

也就是说：**要么“候选阶段”就没覆盖到很多真枪，要么“置信度”把真枪压到阈值以下了**。

### 2. 误报多（FP 高）：不同视频差异大，模型泛化不够

- 1.mp4 相对最好（F1≈37%），2.mp4、5.mp4 极差（F1≈5–6%）。
- 说明：**同一套特征 + LogReg + CNN 在不同枪型、距离、环境下的表现很不稳定**，容易把“非枪声”判成枪声（FP）。
- 训练样本只有 5 段视频、正样本远少于负样本，CNN/LogReg 容易学偏，对 2/5 这种分布泛化差。

### 3. 阈值和流程设计

- **0.32** 是单一全局阈值，没有按视频或场景调。
- 若整体置信度分布“挤在一起”（真枪和误报分数接近），再调阈值也只能在“多检一点 vs 少误报”之间权衡，很难同时提高 P 和 R。

### 4. 数据与标注

- 只有 5 段视频、136 个真值，且真值来自 JPG/手动 .txt，可能有**时间偏差**（±几十毫秒就会在 ±0.04s 匹配下算 FN）。
- 正负样本严重不平衡（例如训练 CNN 时 90 正 vs 465 负），模型容易偏向“判成非枪声”，进一步加剧漏检。

---

## 三、可以怎么做（按优先级）

1. **先看漏检从哪来**  
   用现有脚本对 1～2 段视频做 **GT 诊断**（例如 `main.py` 里已有 `_print_gt_diagnostics`）：看每个 FN 在候选里有没有“附近”的候选、其置信度是多少。若 FN 处根本没有候选 → 要放宽 Stage1 或聚类；若有候选但置信度低 → 要调阈值或改特征/模型。

2. **降阈值试一把**  
   把 **min_confidence_threshold** 从 0.32 降到 **0.2～0.25** 再跑 `evaluate_multivideo.py`，看召回是否明显上去、F1 是否改善。若召回升、F1 升，说明当前阈值偏严。

3. **按视频/场景调参**  
   不同视频用不同阈值或不同 `score_weights`（若后续支持 per-video 配置），避免“为 2/5 调严导致 1 变差”。

4. **增加数据与平衡**  
   多录几段、多标几段；或对正样本做 oversample / 提高 loss 权重，减轻“模型不敢判枪声”的倾向。

5. **加强模型**  
   换更强的特征或更大的 CNN、或引入预训练音频模型（如 YAMNet）做迁移，再在现有 5 段上 fine-tune，看 2/5 是否明显变好。

---

## 四、一句话总结

成功率低主要是因为：**漏检太多（约 77% 真枪没检出）和误报太多（检出的里大部分是错的）**；根因包括候选阶段丢失真枪、置信度阈值偏严、跨视频泛化差、以及数据少且不平衡。先做“降阈值 + GT 诊断”能快速确认是“候选不足”还是“分数被压掉”，再针对性地改候选生成或模型/阈值。
