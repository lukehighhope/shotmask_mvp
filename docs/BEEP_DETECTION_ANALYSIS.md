# Beep 探测成功率分析

## 当前表现（GT 来自 *beep.txt，13 条）

| 结果 | 片段 | 说明 |
|------|------|------|
| **准** (err < 0.01s) | 1.mp4, 3.mp4, S2, S6 | 4/13 |
| **小偏差** (0.5–1.6s) | S3, S7 | 2 |
| **中偏差** (1–3s) | 2.mp4, 4.mp4, 5.mp4, S5 | 4 |
| **大偏差** (>4s) | S1, S4, S8 | 3 |

MAE ≈ 2.76s，成功率（err<1s）约 **6/13**。

---

## 失败原因归纳

### 1. 早峰修正 + 3s 下限误伤晚 beep（S8）

- **S8**：GT 7.59s，pred 3.0s。
- 为 v2 加的「0.5–1.0s 触发 → 在 3s 附近探测并 floor 到 3s」在 S8 上误触发：S8 首个峰在 (0.5,1.0)s，被当成“早噪声”，结果被强制成 3s，而真实 beep 在 7.6s。
- **原因**：早峰修正和 floor 是面向“v2 这类 3s 左右 beep”的启发式，对“首峰很早、真实 beep 在 7s+”的片段不适用。

### 2. 真实 beep 很晚时，“最早峰”不是 beep（S1、S4）

- **S1**：GT 18.1s，pred 2.6s。  
- **S4**：GT 7.54s，pred 1.95s。  
- 策略是「在 0.5–30s 内取最早通过主频校验的强峰」。当 beep 在 7s 或 18s 时，前面已有枪声或噪声形成更强、且主频在 2–5.2kHz 的峰，被误当成 beep。
- **原因**：单用“最早 + 主频”无法区分「第一个 beep」和「第一个听起来像 beep 的枪声/噪声」。

### 3. 真实 beep 被跳过，选了后面的峰（2、4、5、S5）

- **2.mp4**：GT 3.43s，pred 4.75s。  
- **4.mp4**：GT 2.21s，pred 3.46s。  
- **5.mp4**：GT 3.44s，pred 1.16s。  
- **S5**：GT 8.08s，pred 4.93s。  
- 可能情况：  
  - 真实 beep 的 [t, t+0.3]s 窗口主频因混响/噪声不在 2–5.2kHz，未通过主频校验，被跳过；  
  - 或前面有更强的同频峰（如 1.16s、3.46s、4.75s），算法选了“最早通过校验”的却是枪声/噪声。

### 4. 强峰比例 0.55 与阈值

- `min_height_frac=0.55`：只保留高度 ≥ 55% 最大峰高的峰。  
- 若真实 beep 较弱（或最大峰是枪声），beep 可能被滤掉；  
- 若早期噪声在带通内很强，又会成为“强峰”并被主频校验通过，导致误检。

### 5. 主频校验的 0.3s 窗口

- 主频在 [t, t+0.3]s 算，若 beep 起振略晚或混响多，0.3s 内可能掺杂枪声/环境，主频偏离 2–5.2kHz，真实 beep 被判为“非 tonal”而跳过。

---

## 改进方向建议

1. **早峰修正加条件**：仅当「候选里没有 5s 以后的峰」或「时长 < 10s」时才做 3s 附近探测 + floor，避免误伤 S8 这类 7s+ beep。  
2. **晚 beep 片段**：对“首峰很早、但存在 6s 以后强峰”的片段，考虑用「最晚的满足主频的峰」或「与首枪间隔约 1–4s 的峰」等启发式，而不是一律取最早。  
3. **主频校验放宽或自适应**：例如主频范围扩大到 1.5–6kHz，或对 0.3s 窗口做多段（0–0.1s、0.1–0.3s）主频，取与 beep 更一致的一段。  
4. **强峰比例可调**：对已知“beep 弱”的集，适当降低 min_height_frac 或按片段长度/能量自适应。  
5. **优先使用 *beep.txt**：有标注的片段一律用 txt，探测只用于无标注；对 v1/v2 等可保留单独 probe/floor，但用“片段类型”或“时长”限制，避免作用于 S8 这类。

---

## 小结

| 原因 | 影响片段 | 核心问题 |
|------|----------|----------|
| 早峰 3s 修正/floor | S8 | 为 v2 设计的启发式误伤 7s+ beep |
| 最早峰 ≠ beep（前面有枪声/噪声） | S1, S4 | 晚 beep 时“最早 tonal 峰”是枪声 |
| 真实 beep 未过主频或非最早 | 2, 4, 5, S5 | 主频/窗口/强峰过滤把 beep 跳过或选了别的峰 |
| 主频/强峰阈值过严或过松 | 多处 | 要么漏 beep，要么把噪声/枪声当 beep |

整体上，**单一“最早 + 带通 + 主频”策略**在 beep 时间分布差异大（1s～24s）、且与枪声/噪声在时频上重叠时，成功率有限；**有 *beep.txt 时优先用 txt** 能显著提高“可用成功率”。
